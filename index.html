<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#38bdf8">
    <title>Cost Price Calculator - Material Blending</title>
    
    <style>
        :root {
            --color-bg-primary: #0f172a;
            --color-bg-surface: #1e293b;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-primary: #38bdf8;
            --color-primary-hover: #0284c7;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-border: #334155;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1a1f35 100%);
            color: var(--color-text-primary);
            padding: 20px;
            min-height: 100vh;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; color: var(--color-primary); margin-bottom: 10px; }
        .header p { color: var(--color-text-secondary); }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .machine-section {
            background: var(--color-bg-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .machine-title { font-size: 1.5rem; color: var(--color-primary); margin-bottom: 20px; }

        .material-row {
            display: grid;
            grid-template-columns: 1.5fr 0.8fr 0.8fr 0.5fr;
            gap: 12px;
            margin-bottom: 15px;
            align-items: end;
        }

        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 0.85rem; color: var(--color-text-secondary); margin-bottom: 6px; }
        
        .form-group input {
            background: #0f172a;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-primary);
            padding: 10px 12px;
            font-size: 0.95rem;
            width: 100%;
        }

        .add-row-btn {
            background: transparent;
            border: 1px dashed var(--color-primary);
            color: var(--color-primary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .summary-section {
            background: var(--color-bg-surface);
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 25px;
            grid-column: 1 / -1;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .summary-card {
            background: #0f172a;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .summary-card-value { font-size: 1.8rem; color: var(--color-primary); font-weight: 700; }
        .summary-card-unit { font-size: 0.85rem; color: var(--color-text-secondary); }

        .ratio-section {
            background: #0f172a;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .ratio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .final-cost {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(16, 185, 129, 0.2));
            border: 2px solid var(--color-success);
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            margin-top: 20px;
        }

        .final-cost-value { font-size: 2.5rem; color: var(--color-success); font-weight: 700; }

        .btn-group { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        
        .action-btn {
            background: var(--color-primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .reset-btn { background: var(--color-warning); color: #000; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: 600; }

        .delete-btn { background: transparent; color: #ef4444; border: 1px solid #ef4444; padding: 8px; border-radius: 4px; cursor: pointer; }

        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--color-success); color: #fff;
            padding: 16px 24px; border-radius: 6px;
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }

        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>‚öôÔ∏è Cost Price Calculator</h1>
        <p>Material Blending for Machine 1 & Machine 2</p>
    </div>

    <div class="main-grid">
        <div class="machine-section">
            <h2 class="machine-title">üîß Machine 1</h2>
            <div id="machine1-rows"></div>
            <button class="add-row-btn" onclick="addRow('machine1')">+ Add Material</button>
        </div>

        <div class="machine-section">
            <h2 class="machine-title">üîß Machine 2</h2>
            <div id="machine2-rows"></div>
            <button class="add-row-btn" onclick="addRow('machine2')">+ Add Material</button>
        </div>

        <div class="summary-section">
            <h2 class="machine-title">üìä Summary & Blending</h2>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-card-title">Machine 1 Cost</div>
                    <div class="summary-card-value">‚Çπ<span id="m1-cost-per-kg">0.00</span></div>
                    <div class="summary-card-unit">per kg</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-title">Machine 2 Cost</div>
                    <div class="summary-card-value">‚Çπ<span id="m2-cost-per-kg">0.00</span></div>
                    <div class="summary-card-unit">per kg</div>
                </div>
            </div>

            <div class="ratio-section">
                <div style="margin-bottom:10px; color:var(--color-text-secondary)">Blending Ratio (Parts)</div>
                <div class="ratio-grid">
                    <div class="form-group">
                        <label>Machine 1</label>
                        <input type="number" id="ratio1" value="5.5" step="0.1" oninput="calculateBlend()">
                    </div>
                    <div class="form-group">
                        <label>Machine 2</label>
                        <input type="number" id="ratio2" value="1" step="0.1" oninput="calculateBlend()">
                    </div>
                </div>
            </div>

            <div class="final-cost">
                <div style="margin-bottom:10px; color:var(--color-text-secondary)">Final Blended Cost</div>
                <div class="final-cost-value">‚Çπ<span id="final-cost">0.00</span></div>
                <div style="color:var(--color-success)">per kg</div>
            </div>

            <div class="btn-group">
                <button class="action-btn" onclick="saveToday()">üíæ Save Entry</button>
                <button class="action-btn" onclick="exportToExcel()">üìä Export Log</button>
                <button class="action-btn" onclick="downloadPDF()">üì• PDF</button>
                <button class="reset-btn" onclick="resetAll()">üîÑ Reset</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    // Initial State
    const defaultMachine1 = [
        { name: 'Filler 1', qty: 16, price: 25.25 },
        { name: 'Filler 2', qty: 16, price: 24 },
        { name: 'Agro', qty: 16, price: 66 },
        { name: 'Mix b-14', qty: 8, price: 64 }
    ];
    const defaultMachine2 = [
        { name: 'Titan', qty: 4, price: 89 },
        { name: 'Endothene', qty: 4, price: 75 },
        { name: 'Panni', qty: 2, price: 75 },
        { name: 'Master batch', qty: 2.5, price: 155 }
    ];

    let machine1 = JSON.parse(JSON.stringify(defaultMachine1));
    let machine2 = JSON.parse(JSON.stringify(defaultMachine2));
    let dailyLog = [];

    // --- Core Functions ---

    function renderRows(machineId) {
        const container = document.getElementById(`${machineId}-rows`);
        const data = machineId === 'machine1' ? machine1 : machine2;
        
        container.innerHTML = data.map((item, idx) => `
            <div class="material-row">
                <div class="form-group">
                    <label>Material</label>
                    <input type="text" value="${item.name}" onchange="updateField('${machineId}', ${idx}, 'name', this.value)">
                </div>
                <div class="form-group">
                    <label>Kg</label>
                    <input type="number" value="${item.qty}" step="0.01" oninput="updateField('${machineId}', ${idx}, 'qty', parseFloat(this.value))">
                </div>
                <div class="form-group">
                    <label>‚Çπ/kg</label>
                    <input type="number" value="${item.price}" step="0.01" oninput="updateField('${machineId}', ${idx}, 'price', parseFloat(this.value))">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="delete-btn" onclick="deleteRow('${machineId}', ${idx})">√ó</button>
                </div>
            </div>
        `).join('');
    }

    function updateField(machineId, idx, field, value) {
        const data = machineId === 'machine1' ? machine1 : machine2;
        data[idx][field] = value;
        calculateBlend();
    }

    function addRow(machineId) {
        const data = machineId === 'machine1' ? machine1 : machine2;
        data.push({ name: '', qty: 0, price: 0 });
        renderRows(machineId);
    }

    function deleteRow(machineId, idx) {
        const data = machineId === 'machine1' ? machine1 : machine2;
        data.splice(idx, 1);
        renderRows(machineId);
        calculateBlend();
    }

    function calculateBlend() {
        // Helper for single machine
        const getStats = (data) => {
            const totalCost = data.reduce((sum, item) => sum + (item.qty * item.price), 0);
            const totalQty = data.reduce((sum, item) => sum + item.qty, 0);
            return { cost: totalCost, qty: totalQty, avg: totalQty ? totalCost/totalQty : 0 };
        };

        const m1 = getStats(machine1);
        const m2 = getStats(machine2);

        const r1 = parseFloat(document.getElementById('ratio1').value) || 0;
        const r2 = parseFloat(document.getElementById('ratio2').value) || 0;
        const totalR = r1 + r2;

        const final = totalR ? ((m1.avg * r1) + (m2.avg * r2)) / totalR : 0;

        // Update DOM
        document.getElementById('m1-cost-per-kg').innerText = m1.avg.toFixed(2);
        document.getElementById('m2-cost-per-kg').innerText = m2.avg.toFixed(2);
        document.getElementById('final-cost').innerText = final.toFixed(2);
        
        saveToLocalStorage();
    }

    // --- Saving & Exporting ---

    function saveToday() {
        const entry = {
            date: new Date().toLocaleString(),
            m1_cost: document.getElementById('m1-cost-per-kg').innerText,
            m2_cost: document.getElementById('m2-cost-per-kg').innerText,
            final_cost: document.getElementById('final-cost').innerText
        };
        dailyLog.push(entry);
        saveToLocalStorage();
        showToast("‚úÖ Saved to Session Log");
    }

    function exportToExcel() {
        if(dailyLog.length === 0) return showToast("‚ö†Ô∏è No saved entries to export!");
        
        const ws = XLSX.utils.json_to_sheet(dailyLog);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Cost Log");
        XLSX.writeFile(wb, "Cost_Price_Log.xlsx");
    }

    function downloadPDF() {
        const element = document.body;
        html2pdf().set({ margin: 10, filename: 'cost-calc.pdf' }).from(element).save();
    }

    function resetAll() {
        if(confirm("Reset all values?")) {
            localStorage.removeItem('costData');
            location.reload();
        }
    }

    // --- Utilities ---

    function saveToLocalStorage() {
        const data = { machine1, machine2, dailyLog };
        localStorage.setItem('costData', JSON.stringify(data));
    }

    function loadFromLocalStorage() {
        const saved = localStorage.getItem('costData');
        if(saved) {
            const parsed = JSON.parse(saved);
            machine1 = parsed.machine1 || machine1;
            machine2 = parsed.machine2 || machine2;
            dailyLog = parsed.dailyLog || [];
        }
    }

    function showToast(msg) {
        const t = document.createElement('div');
        t.className = 'toast';
        t.innerText = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    // Init
    loadFromLocalStorage();
    renderRows('machine1');
    renderRows('machine2');
    calculateBlend();

</script>
</body>
</html>
